# linux 的 /dev/ 设备文件

/dev/下的设备文件可以像普通文件一样打开并读写。读的时候，就是从设备里取出了东西；写的时候，就是往设备里塞东西。一般的是这样。但是设备文件与具体的设备，以及设备之间的关系到底是怎样的呢？经过探索，总结出下面一些东西。

/dev/设备文件确实是一个文件，一个像普通文件一样存在于硬盘上的文件。如果对dev所在的分区做一个磁盘备份，然后把镜像文件在别的地方mount后，仍然会看到这些设备文件。

那么它是怎么和设备产生关系的呢？从设备文件的建立就可以看出：建立设备文件用mknod命令，需要的参数主要是设备文件名，主要设备号与次要设备号。设备文件名当然就是/dev/下看到的文件名。而令设备文件与设备产生关系的，就是这个主要设备号与次要设备号。用 ```ls -l /dev/``` 也能看出来：
```
crw-------   1 root root  36,  16 Feb 25 18:41 tap0
crw-------   1 root root  36,  17 Feb 25 18:41 tap1
crw-------   1 root root  36,  26 Feb 25 18:41 tap10
```
以上的36,16中，36是主设备号，16是次设备号。

当操作到设备文件的时候，内核会根据这两个设备号令设备文件与具体的设备扯上关系。这样看，设备文件就像是个文件软链一样。

那么这两个设备号到底是什么呢？其实主设备号是会对应到设备驱动程序的。不同的主设备号对应不同的设备驱动程序，主设备号是驱动程序初始化注册设备的时候得到的一个数字。【主设备号表明了某一类设备，一般对应着确定的驱动程序；次设备号一般是区分不同属性，例如不同的使用方法，不同的位置，不同的操作。这个设备号是从/proc/devices文件中获得的，所以一般是先有驱动程序在内核中，才有设备节点在目录中。这个设备号（特指主设备号）的主要作用，就是声明设备所使用的驱动程序。驱动程序和设备号是一一对应的，当你打开一个设备文件时，操作系统就已经知道这个设备所对应的驱动程序。——见 http://www.ibm.com/developerworks/cn/linux/l-usb/index1.html 】而从设备号会原封不动透传给驱动程序，令设备驱动程序用来区分不同的该类型的设备。

这样看来，当要操作设备的时候，是通过设备文件操作的，而又间接的通过设备的驱动程序来操作。所以说，只有有了相应的设备驱动程序的时候，这个设备文件才是有效的。但又因为设备文件就像个软链，所以如果设备驱动程序不存在，这个设备文件照样可以存在，只是导致操作设备失败而已。

【总结】下：
- 设备一般是插在总线上的。所以设备到底存在不，用lsusb、lspci等可以看到设备是否已经插成功。
- 看到设备已经在总线上了，但是设备还是不可用，那么需要看设备驱动程序。设备驱动程序不ok，相应的/dev/下不会出现相应的设备文件的（或者说出现有效的设备文件；有可能设备不插入的时候，已经存在设备文件了）。
- 设备驱动程序ok后，如果设备文件也ok，那么就可以通过设备文件来操控具体的设备了。

【补记】

在测试环境下，把整个dev都删除后，系统各方面表现都正常。可见，内核并不是通过设备文件与设备打交道的。

2014-04-09

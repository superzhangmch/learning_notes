

## GC çš„æ ¸å¿ƒæŠ½è±¡ï¼šå¯¹è±¡å›¾ + æ ¹é›†åˆ

### å¯¹è±¡å›¾ï¼ˆObject Graphï¼‰

* å¯¹è±¡ = èŠ‚ç‚¹
* å¼•ç”¨ = æœ‰å‘è¾¹

### æ ¹é›†åˆï¼ˆRootsï¼‰

GC ä»è¿™äº›åœ°æ–¹å¼€å§‹â€œæ‰¾æ´»å¯¹è±¡â€ï¼š

* æ ˆä¸Šçš„å±€éƒ¨å˜é‡
* å¯„å­˜å™¨ä¸­çš„å¼•ç”¨
* å…¨å±€å˜é‡
* å¸¸é‡æ± 
* JIT / VM å†…éƒ¨å¼•ç”¨

> **ä»æ ¹å¯è¾¾çš„å¯¹è±¡ = æ´»çš„
> ä¸å¯è¾¾çš„å¯¹è±¡ = åƒåœ¾**

---- 

## CPython çš„ GC

### åŒæœºåˆ¶è®¾è®¡

1. **å¼•ç”¨è®¡æ•°**ï¼šå¤„ç†ç»å¤§å¤šæ•°å¯¹è±¡
2. **å¾ªç¯ GC**ï¼šä¸“é—¨å¤„ç†å¼•ç”¨è®¡æ•°å›ä¸æ‰çš„ç¯

###CPython å¦‚ä½•å¤„ç†å¾ªç¯å¼•ç”¨ï¼ˆæ ¸å¿ƒï¼‰

#### å…³é”®å­—æ®µ

* `ob_refcnt`ï¼šçœŸå®å¼•ç”¨è®¡æ•°
* `gc_refs`ï¼šGC æœŸé—´çš„**ä¸´æ—¶è®¡æ•°**

#### æ ¸å¿ƒç®—æ³•ï¼ˆç®€åŒ–ï¼‰

```
gc_refs = ob_refcnt
for internal_edge:
    target.gc_refs -= 1

gc_refs == 0  â‡’ only-internal â‡’ garbage
```

ğŸ‘‰ **ä¸æ˜¯ tracingï¼Œè€Œæ˜¯â€œæ‰£å†…éƒ¨å¼•ç”¨â€**

## ä¸åŒè¯­è¨€ / VM çš„ GC é£æ ¼å¯¹æ¯”

| ç³»ç»Ÿ           | GC ç‰¹ç‚¹                |
| ------------ | -------------------- |
| Java HotSpot | åˆ†ä»£ + å¹¶å‘ + å‹ç¼©         |
| V8           | åˆ†ä»£ + å¹¶å‘ + ç²¾ç»†å†™å±éšœ      |
| JSC          | åˆ†ä»£ + LLVM æ”¯æŒ         |
| CPython      | refcount + cyclic GC |
| Rust         | âŒï¼ˆè¯­è¨€å±‚é¢æ—  GCï¼‰          |

## ä¸€ä¸ªæç®€ä½†æ­£ç¡®çš„ GC ä¼ªæ¨¡å‹

```text
roots = get_roots()
mark all reachable objects
free all unmarked objects
```

æ‰€æœ‰ GCï¼Œæœ¬è´¨éƒ½åœ¨ä¼˜åŒ–è¿™ä¸‰æ­¥ã€‚

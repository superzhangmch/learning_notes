# C++中虚函数的调用成本

都说虚函数的使用会影响性能。所以在关注性能的地方，我们用起虚函数来，总是战战兢兢，总觉得用的不够优雅。今天特地因故探索了下，发现对性能的影响是，既大又小；需要分情况说了。

先看下虚函数的实现与使用的一些细节。  

首先对于任何一个类，只要一个类自身定义有virtual 函数，或者基类有virtual函数，那么该类的实例一定会有虚函数表。而且总是基类的虚函数表在前，自身的在后面。如果本类有函数覆盖了基类的虚函数，那么该虚函数在虚函数表中，是会在基类的部分覆盖基类的对应函数。另外，虚函数表(或表指针)往往占据类实例所占内存的最开始一些字节。  

这样子下，假如有个多层的继承链，那么对于最底层的类实例来说，其虚函数表会包含有各个父级的虚函数表，且都是以头包含方式。特别地，**对于一个多层的继承链，假如第二层起，没有定义新的虚函数，那么每层的虚函数表的表项以及总个数是一样的**！！其实正是从这一点，我们可以看到，虚函数的调用过程是怎样查表的。  

一说查表，可能感觉是不是查表是用的函数名的字符串匹配之类？其实呢，当然不是了。因为各层的虚函数表一样，所以不管父类指针到底指向的是哪个子类，都是可以(注意：如果子类有某虚函数在父类中不是虚函数，那么这个函数本身就不能通过父类指针访问到)用同一个逻辑来给调用到的虚函数赋值（像函数指针赋值）的。这个统一逻辑是这样的：编译器当然知道通过父类指针调用的函数处于虚函数表的哪个位置！！**也就是说虚函数表的表查询，是编译期就由编译器做好的。运行期只是得到这个已知位置的具体值而已。正因此，所以虚函数表的调用语句，对应到汇编后，其实也就多了若干条汇编指令而已。如果编译器优化的好，可能只多了一二三条指令。**

-----

说到这里，已经可以感觉到了，虚函数的调用，对性能的影响真是微乎其微。

-----


实际上，虚函数对于性能的影响，表现在其他方面。  
- 第一、可能打乱cpu的流水线，导致性能问题。实际上用到函数指针时，就往往会导致这个问题。  
- 第二、如果一个函数本来就函数体内容少，同时执行非常频繁，那么确实会导致严重的性能问题。（假如函数体对应到汇编，也就一两条汇编指令；那么可以想见，虚函数化后，所用时间，极有可能会翻倍）

【参考】
- http://blog.csdn.net/hengyunabc/article/details/7461919
- http://stackoverflow.com/questions/8005791/c-virtual-table-lookup-how-does-it-search-replace

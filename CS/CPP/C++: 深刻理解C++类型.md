# C++: 深刻理解C++类型

C++中的类型，一方面很简单；但是如果深究起来，又是非常复杂的，会复杂到不管你认为你多么懂了，都会在真面对某个复杂类型的时候，自卑起来，比如：

```void (*(*signal)(int, void (*)(int)))(int);```

其实不管多么复杂的类型定义，C++中的类型的分析都是有章可循的，只要原理与规则都搞清了，自然就可以一切水落石出豁然开朗了。

----
(下面不考虑引用&, const 等，可以自己脑补)

首先，只看数据类型，先不考虑函数类型。

假设有一个有确切的类型名的类型(int等内置类型或struct/class/union/enum，或对复杂组合类型做的typedef) T。那么由数组或指针，T 可以衍生出如下类型：
```
1). T
2). T [N1]
3). T [N1]...[Nn] // 伪码地说，相当于 (T [N2]...[Nn]) [N1]。 类型 T [N2]...[Nn] 的N1 维数组
4). T * 
5). T * [N1]
6). T * [N1]...[Nn] // 多维指针数组。 伪码地说，相当于 (T * [N2]...[Nn]) [N1]
7). T (*) [N1]...[Nn] //  伪码地说，相当于 (T [N1]...[Nn]) * 
8). T (*[M1]) [N1]...[Nn]
9). T (*[M1]...[Mm]) [N1]...[Nn] // 伪码地说，相当于 (T [N1]...[Nn]) * [M1]...[Mm]
10). 把上面的每个地方的*， 换成 s 个星
```

如果用一个通式子来表示应该就是：
```T (*_1 *_2 ... *_s [M]...[Mm]) [N1]...[Nn]```
其中s，m，n这三维中的每一个都可以长度是0.


用这些类型怎么定义变量呢？规则是，如果有*，那么变量名紧跟在最后一个*后面。如果没有*，那么变量名插入到第一个“[”前面。如果* 与 [ 都没有，那么当然退化为最简单情况了。

-----

在以上搞清楚之后，下面讨论函数类型的情况。首先需要指明，被typedef出来的函数类型，也能像上面那样再组合出更复杂的类型，下面讨论先忽略这种情况。

按一般人的理解，函数类型大概是这个形式的：
``` return_type （* (type_1 , type_2, ..., type_n); ```
比如 ``` double (* ) (char, int, char *); ```

这容易使人以为，函数类型就是这样简单的三段式依次从左往右排下来：返回类型部分(对应int)，函数名部分(对应上面(*))，参数列表部分(对应上面（char, int, char *）)。

实际上，虽然大部分时候是这样，但却不是那么简单的就是这样。

按上面那样，返回类型不会是函数类型中的小小一部分而已。实际上，函数类型的定义，是紧紧围绕着返回类型的。实际上，从怎样才能正确的定义出一个符合需求的函数类型就可以看出来。


定义函数类型的过程，如果拆分开来讲，是这样的：
```
Step 1. 把返回类型写成上面的T (*_1 *_2 ... *_s [M]...[Mm]) [N1]...[Nn]这样的形式，然后用这个类型定义一个变量名为 t 的变量。
比如假设返回类型是 int (*[3])[4], 那么先定义变量int (*t[3])[4];
Step 2. 把函数名部分与参数列表部分 组合起来，假设组合后的字符串是 f
比如假设要定义函数指针数组 *[5], 参数列表是(char, int, char*), 那么 f="(*[5])(char, int, char *)" 
Step 3. 把上面的step 1中的 t，用step 2 中的 f字符串替换。最终得到的这个字符串，就是最终的函数类型了。
比如，承上1,2，那么最终的函数类型是：int (*(*[5])(char, int, char *)[3])[4] == int(*f[3])[4];
```

有了上面分析，那么```void (*(*signal)(int, void (*)(int)))(int);```就容易理解了：
```
1). void (*t )(int);  
2). f = (*signal)(int, f1), f1 = void (*)(int)
3). 用 f 替换t 得到 void (*(*signal)(int, void (*)(int)))(int)
```
signal 是函数指针名，(*signal) 对应函数名部分。```(int, t1)``` == ```(int, void (*)(int))``` 是参数列表，第一个参数是int类型，第二个参数是个函数指针类型。然后用 f= (*signal)(int, f1) 替换 void (*t )(int) 中的 t 得到的``` void (*(*signal)(int, void (*)(int)))(int)```。

补记：
关于数组类型：C/C++ 数组使用一般是var_nam[数字]形式，其实如果"数字[变量名]"也是可以的。这是因为，变量名本质上就是个地址，var_nam[数字]本质上表达的是 var_nam地址 + 数字。

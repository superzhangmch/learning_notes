# Linux 下的内存管理

用户空间申请或释放内存，往往是通过C/C++的 malloc/new/free/delete等函数。而这几个函数，又是通过 sbrk， mmap 等系统调用来完成。sbrk 就是简单调整堆的大小，mmap 则是直接在虚拟内存空间划出一个范围来而已。其实并没有发生什么实际的内存分配（看怎么看了，其实没有发生物理内存分配而已）。

真正的（物理）内存分配，发生在当访问到这些内存的时候。会以缺页异常的方式来分配得到具体的物理内存。也就是说malloc/new分配的（虚拟）内存其实就是个空头支票。当实际用到的时候，才会分配对应的物理内存。

以上是一种需要用到物理内存的情况。还有一种情况是，对于已经给虚拟内存配对到了物理内存的情况，如果这块虚拟内存经久不怎么用，可能就会把其交换出去到硬盘；然后这块对应的物理内存就可以做别的用了。当再次需要的时候，就是再次分配物理内存，并把copy到硬盘的东西，再copy回来。

除了以上，内核还是会不时的会用到物理内存的。比如分配各种各样的***描述符。

总之这些都是对物理内存的需要。内核怎样管理物理内存的呢？

内核对物理内存的分配，用的是一个叫 slab cache 的东西来分配的。这个东西大概是说：它对于不同的物理内存需要，已经是再就准备好了，可以说对各种需求都维护好了一个队列。你要怎样的一个（比如要求分配一个进程描述符），它基本上都能直接从相应队列里直接给你摘取一个就是了（所以说是cache呢）。

那么，slab 这个东西是在底层怎样管理物理内存的呢？实际上，它需要具体（比如不当能直接满足你的需求时）物理内存的时候，会由一个叫做 buddy 算法非配器来分配。这个buddy 分配器就是维护了好多各种幂二（二的某次方）大小的连续物理内存块。对于slab 对它的内存需要，它会挑选一个最合适的给slab。当slab 归还给它时，它又会把相邻的若干个块按幂二方式合并。

#### 下面说下地址空间。

就按32位x86 下的linux说吧。其中的一些，在x86 64位下是不存在的，但是如果某天机器配备的内存也是海量（真的很难达到）的了，那么 x86-64其实也会遇到这样的问题。

32位 x86 下的linux 的进程的（虚拟）地址空间一般是这样的：0G~3G是用户态地址空间，3G~4G是内核态地址空间；也就是说3G~4G范围内的虚拟内存，只有内核可以访问。至于4G后的地址，不好意思，Linux这时候不支持。前3G的内存，当具体使用到的时候，当然是通过页表映射的方式使用的，你真不知道具体的一个虚拟内存页会映射到物理内存的什么地方。可以说是随机的。后1G的虚拟内存呢？这1G是内核专用的，因此就很不一样了。

首先，内核使用虚拟内存的时候，是用的直接映射到物理内存的方式。映射方式是物理地址加上某个固定的常数后，就是对应的虚拟地址。这个固定的常数为什么不选为0我就不知道了，总之是，x86-32下，这个常数就是3G。所以才3G-4G是内核空间地址呢。至于为什么要连续映射呢？据说是这样：有些外设会把自己的交互接口映射到连续物理内存（而且可能这段连续物理内存会占用好多个物理页）内；而内核会和这些外设打交道，而内核也是工作在虚拟地址下的，如果不用简单的虚拟物理映射法，内核就将很难与这些外设交涉。

然后，就是内核其实只能直接使用1G的物理内存。因为都是直接映射了，如果要使用1G以上的地址，比如1.5G的地址，那么好，1.5G+3G=4.5G，这又超过了4G的内存限制。所以只能直接用到1G物理内存的。但是内核可是需要能够访问到所有的物理地址的啊，怎么办呢？只能迂回呗。办法就是在这1G的虚拟地址空间里，空出一部分用于迂回，空出的这一部分是128M，正好对应到了896M~1G的物理内存。因此才说896M以上是高位内存呢，就是这个道理。

迂回的实现方式其实很简单。仍然是靠得地址映射，只是不是用的直接加常数的方式映射，而是像用户空间内存那样的随机映射方式。当然这个映射的实现，正如用户空间一样，靠得是页表方式。说到这里，那么内核的加常数直接映射到底怎么实现的呢？其实呀，仍然靠得是页表方式；只是这个页表内容比较有规律递增上去的罢了（既然cpu处于分页模式下，那么，不管哪里对内存的访问都是虚拟地址方式的；因此内核的直接映射，不过是页表不同罢了）。

<br>

另外补充一点，在内核内存管理的最最底层，有一个数据结构是页描述符，这个是每个页（一般4K）一个，因此对于大内存机器来说，所有的这个结构体占用的体积真是好大啊。

#### 下面说下交换分区/交换文件/交换空间。

可以参考这个：https://www.linux.com/news/software/applications/8208-all-about-linux-swap-space 。

交换空间可以由交换分区或交换文件组成。每种可以有多个，且可以两种同时出现。两者起的作用完全一样，只是一个是硬盘上一个固定分区，另一个是某个分区上一个普通文件充当了特殊作用而已。查看交换空间的具体组成情况，用 swapon -s(实际上，是从/proc/swaps里读的).

系统在物理内存不够用的时候，会强制交换某些东西到交换空间。另外还会周期性的把某些交换出去，即使内存够用。一些东西，比如匿名映射文件，就会被交换进去。

2014-06-12
